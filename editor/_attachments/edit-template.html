<!doctype html>
<meta charset=utf-8>

<title>Edit site template</title>

<link rel=stylesheet/less href=style/common.less>
<script src=third-party/less-1.1.3.min.js></script>
<script src=third-party/jquery-1.7.1.min.js></script>
<script src=third-party/request.jquery.js></script>
<script src=script/common.js></script>

<nav class=toolbar>
  <p>
    <button class=primary form=edit-template>Save changes</button>
</nav>

<form id=edit-template>
  <fieldset>
    <p>
      <label>
        Template
        <textarea name=template autofocus></textarea>
      </label>
  </fieldset>
</form>

<script>
  $(function() {
    var design;

    $('textarea').keyup(function() {
      if (this.scrollHeight > this.clientHeight) {
        this.style.height = this.scrollHeight +
          (this.offsetHeight - this.clientHeight) + 'px';
      }
    });

    $.request({
      url: 'api/*site',
      json: true
    }, function(err, resp, doc) {
      design = doc;
      $('#edit-template [name=template]').val(doc.templates.default).keyup();
    });

    $('#edit-template').submit(function() {
      var template = $('textarea[name=template]').val();
      design.templates.default = template;

      $('button[form=edit-template]').text('Saving changesâ€¦').attr('disabled', true);

      $.request({
        method: 'PUT',
        url: 'api/*site',
        json: true,
        body: JSON.stringify(design),
      }, function(err, resp, body) {
        design._rev = body.rev;
        $('button[form=edit-template]').text('Save changes').attr('disabled', false);
      });

      return false;
    });
  });
</script>
